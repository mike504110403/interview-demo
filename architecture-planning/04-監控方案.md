# 監控與稽核方案

## 🎯 監控目標

### 三個維度的監控

```
維度 1: "誰" 做了什麼
- 使用者身份
- 操作時間
- 存取的服務

維度 2: "系統" 運行狀況
- 資源使用率
- 效能指標
- 錯誤率

維度 3: "安全" 事件追蹤
- 異常行為
- 安全威脅
- 合規性
```

---

## 📊 完整監控架構

```
═══════════════════════════════════════════════════════════
              資料來源層 (Data Sources)
═══════════════════════════════════════════════════════════

┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ VPN Gateway │  │   GitLab    │  │ Application │
│    Logs     │  │    Logs     │  │    Logs     │
└──────┬──────┘  └──────┬──────┘  └──────┬──────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
═══════════════════════════════════════════════════════════
              收集層 (Collection)
═══════════════════════════════════════════════════════════
                        │
                   ┌────▼────┐
                   │Filebeat │
                   │         │
                   │ 日誌收集 │
                   └────┬────┘
                        │
═══════════════════════════════════════════════════════════
              處理層 (Processing)
═══════════════════════════════════════════════════════════
                        │
              ┌─────────▼─────────┐
              │    Logstash       │
              │                   │
              │ - 解析日誌         │
              │ - 標準化格式       │
              │ - 過濾 & 轉換      │
              └─────────┬─────────┘
                        │
═══════════════════════════════════════════════════════════
              儲存層 (Storage)
═══════════════════════════════════════════════════════════
                        │
           ┌────────────┼────────────┐
           │            │            │
      ┌────▼────┐  ┌────▼────┐  ┌───▼────┐
      │Elastic  │  │Prometheus│ │TimeSeries│
      │ Search  │  │         │ │   DB    │
      └────┬────┘  └────┬────┘ └───┬────┘
           │            │           │
═══════════════════════════════════════════════════════════
              分析 & 視覺化層 (Visualization)
═══════════════════════════════════════════════════════════
           │            │           │
      ┌────▼────┐  ┌────▼────┐ ┌───▼────┐
      │ Kibana  │  │ Grafana │ │Custom  │
      │         │  │         │ │Dashboard│
      └────┬────┘  └────┬────┘ └───┬────┘
           │            │           │
           └────────────┼───────────┘
                        │
═══════════════════════════════════════════════════════════
              告警層 (Alerting)
═══════════════════════════════════════════════════════════
                        │
                 ┌──────▼──────┐
                 │Alertmanager │
                 │             │
                 │  告警規則    │
                 │  通知路由    │
                 └──────┬──────┘
                        │
           ┌────────────┼────────────┐
           │            │            │
      ┌────▼────┐  ┌────▼────┐  ┌───▼────┐
      │ Slack   │  │  Email  │  │  SMS   │
      └─────────┘  └─────────┘  └────────┘
```

---

## 📝 監控資料來源

### 1. VPN Gateway 監控

**監控項目**：
```yaml
連線事件:
  - 連線建立/斷開
  - 連線持續時間
  - 傳輸資料量
  - 連線失敗原因

使用者行為:
  - 登入時間模式
  - 存取的服務
  - 流量模式
  - 異常行為指標

系統指標:
  - CPU 使用率
  - 記憶體使用
  - 網路頻寬
  - 連線數量
```

**日誌格式範例**：
```json
{
  "timestamp": "2025-12-18T10:30:15Z",
  "event_type": "vpn_connect",
  "user": "engineer_a",
  "client_ip": "1.2.3.4",
  "vpn_ip": "10.0.0.25",
  "location": {
    "country": "TW",
    "city": "Taipei"
  },
  "status": "success"
}
```

### 2. GitLab 監控

**監控項目**：
```yaml
用戶操作:
  - 登入/登出
  - Git clone/pull/push
  - 建立/刪除專案
  - 權限變更
  - Merge Request

CI/CD:
  - Pipeline 執行
  - 建置成功/失敗率
  - 部署記錄
  - Runner 狀態

系統事件:
  - 系統錯誤
  - 效能指標
  - API 呼叫
  - 儲存空間使用
```

**關鍵記錄範例**：
```json
{
  "timestamp": "2025-12-18T10:35:20Z",
  "event_type": "git_push",
  "user": "engineer_a",
  "project": "backend-api",
  "branch": "feature/new-auth",
  "commits": 3,
  "size_mb": 2.5,
  "client_ip": "10.0.0.25"
}
```

### 3. 應用服務監控

**監控項目**：
```yaml
應用層:
  - HTTP 請求/回應
  - API 端點存取
  - 錯誤率
  - 回應時間

業務層:
  - 關鍵業務操作
  - 交易記錄
  - 使用者行為
  - 資料變更

技術層:
  - 資料庫查詢
  - 快取命中率
  - 背景任務
  - 第三方 API 呼叫
```

### 4. 系統層監控

**監控項目**：
```yaml
資源使用:
  - CPU 使用率
  - 記憶體使用
  - 磁碟 I/O
  - 網路流量

服務狀態:
  - 進程運行狀態
  - 服務可用性
  - 端口監聽
  - 系統負載

安全事件:
  - SSH 登入
  - Sudo 使用
  - 檔案變更
  - 網路連線
```

---

## 🎯 關鍵監控指標 (KPIs)

### 安全指標

```yaml
身份驗證:
  - 成功登入次數
  - 失敗登入次數
  - 失敗率 (< 1%)
  - 異常時間登入數 (目標: 0)

存取控制:
  - 權限變更次數
  - 未授權存取嘗試
  - 違規操作次數 (目標: 0)

資料保護:
  - 敏感資料存取次數
  - 大量下載事件
  - 資料外洩事件 (目標: 0)
```

### 效能指標

```yaml
系統效能:
  - VPN 連線延遲 (< 50ms)
  - 服務回應時間 (< 200ms)
  - CPU 使用率 (< 70%)
  - 記憶體使用率 (< 80%)

服務可用性:
  - 服務正常運行時間 (> 99.9%)
  - 每月故障時間 (< 43分鐘)
  - 平均恢復時間 (< 15分鐘)

CI/CD 效能:
  - Pipeline 成功率 (> 95%)
  - 平均建置時間 (< 10分鐘)
  - 部署頻率 (每日 > 3次)
```

### 業務指標

```yaml
團隊生產力:
  - 每日 commit 數
  - Merge Request 數量
  - Code Review 時間
  - Issue 解決速度

系統使用:
  - 活躍使用者數
  - 平均連線時長
  - 尖峰使用時段
  - 資源使用趨勢
```

---

## 📋 監控儀表板設計

### Dashboard 1: 即時安全監控

```
┌──────────────────────────────────────────────────────────┐
│                   即時安全監控                            │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  目前連線用戶: 12人        異常事件: 0                     │
│  今日登入次數: 156次       告警數量: 2 (低優先級)         │
│                                                          │
├────────────────────┬─────────────────────────────────────┤
│  VPN 連線狀態       │  最近登入事件                        │
│  ┌───────────────┐ │  ┌────────────────────────────────┐ │
│  │ [圖表]        │ │  │ 10:35 - engineer_a - 成功       │ │
│  │ 連線數趨勢     │ │  │ 10:32 - designer_b - 成功       │ │
│  │               │ │  │ 10:28 - engineer_c - 失敗       │ │
│  └───────────────┘ │  └────────────────────────────────┘ │
├────────────────────┼─────────────────────────────────────┤
│  異常行為偵測       │  安全事件                           │
│  ┌───────────────┐ │  ┌────────────────────────────────┐ │
│  │ [地圖]        │ │  │ ⚠️  3次失敗登入 (IP: x.x.x.x)   │ │
│  │ 連線來源分布   │ │  │ ℹ️  權限變更請求 (user: xxx)    │ │
│  └───────────────┘ │  └────────────────────────────────┘ │
└────────────────────┴─────────────────────────────────────┘
```

### Dashboard 2: 系統效能監控

```
┌──────────────────────────────────────────────────────────┐
│                   系統效能監控                            │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  VPN Gateway    CPU: 45%   Memory: 62%   Uptime: 45天   │
│  GitLab Server  CPU: 38%   Memory: 71%   Uptime: 45天   │
│                                                          │
├─────────────────────────────────────────────────────────┤
│  資源使用趨勢 (過去24小時)                                │
│  ┌────────────────────────────────────────────────────┐ │
│  │ [折線圖]                                            │ │
│  │ CPU / Memory / Network / Disk I/O                  │ │
│  └────────────────────────────────────────────────────┘ │
├────────────────────┬────────────────────────────────────┤
│  服務健康檢查       │  告警歷史                           │
│  ✅ GitLab         │  過去24小時: 2個告警                 │
│  ✅ Dev Env        │  過去7天: 8個告警                    │
│  ✅ Staging        │  過去30天: 23個告警                  │
│  ✅ Monitoring     │                                    │
└────────────────────┴────────────────────────────────────┘
```

### Dashboard 3: 業務與團隊

```
┌──────────────────────────────────────────────────────────┐
│                 團隊生產力儀表板                          │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  今日統計:                                                │
│  Commits: 47    Merge Requests: 12    Code Reviews: 8   │
│                                                          │
├────────────────────┬─────────────────────────────────────┤
│  Commit 趨勢       │  Pipeline 狀態                       │
│  [柱狀圖]          │  ✅ 成功: 45                         │
│  過去7天每日commit │  ❌ 失敗: 3                          │
│                   │  ⏳ 執行中: 2                         │
├────────────────────┼─────────────────────────────────────┤
│  團隊活躍度         │  Issue 狀態                         │
│  [熱度圖]          │  Open: 23                           │
│  各成員貢獻        │  In Progress: 15                    │
│                   │  Resolved: 8 (本週)                  │
└────────────────────┴─────────────────────────────────────┘
```

### Dashboard 4: 稽核記錄

```
┌──────────────────────────────────────────────────────────┐
│                     稽核記錄                              │
├──────────────────────────────────────────────────────────┤
│  時間範圍: [過去24小時 ▼]    搜尋: [_______________] 🔍  │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  時間              使用者       操作           資源        │
│  ────────────────────────────────────────────────────── │
│  10:35:20  engineer_a  git_push    backend-api         │
│  10:32:15  designer_b  login       gitlab              │
│  10:28:05  engineer_c  access      staging-db          │
│  10:25:30  tech_lead   permission  change_role         │
│  10:20:10  engineer_d  deploy      production          │
│  ...                                                    │
│                                                          │
│  [匯出 CSV]  [匯出 PDF]  [產生報告]                      │
└──────────────────────────────────────────────────────────┘
```

---

## 🚨 告警規則設計

### 安全告警

```yaml
# 高優先級 (Critical)
- 名稱: 異常時間登入
  條件: 登入時間 < 06:00 OR > 23:00
  行動:
    - 立即通知 CTO (Email + Slack + SMS)
    - 記錄詳細日誌
    - 可選: 自動暫停 VPN

- 名稱: 大量資料下載
  條件: 單次下載 > 1GB OR 1小時內 > 5GB
  行動:
    - 通知 CTO + Tech Lead
    - 自動暫停 VPN 連線
    - 建立安全事件單

- 名稱: 權限提升嘗試
  條件: 未授權的權限變更請求
  行動:
    - 立即通知 CTO
    - 記錄完整操作軌跡
    - 阻擋操作執行

# 中優先級 (Warning)
- 名稱: 多次登入失敗
  條件: 10分鐘內失敗 > 5次
  行動:
    - Slack 通知
    - 封鎖 IP 1小時
    - 記錄嘗試細節

- 名稱: 新 IP 登入
  條件: 使用者從未使用過的 IP 登入
  行動:
    - Email 通知使用者確認
    - 記錄地理位置
    - 增強監控該使用者

# 低優先級 (Info)
- 名稱: 離線設備上線
  條件: 超過7天未連線的設備重新連線
  行動:
    - Slack 通知
    - 記錄事件
```

### 系統告警

```yaml
# Critical
- 名稱: 服務宕機
  條件: 服務無回應 > 2分鐘
  行動:
    - 立即通知值班工程師
    - 自動嘗試重啟
    - 啟動備援系統

- 名稱: 磁碟空間不足
  條件: 可用空間 < 10%
  行動:
    - 通知 Ops 團隊
    - 自動清理暫存檔
    - 檢查異常大檔案

# Warning
- 名稱: 高 CPU 使用
  條件: CPU > 80% 持續 10分鐘
  行動:
    - Slack 通知
    - 記錄當時程序
    - 建議優化

- 名稱: 記憶體不足
  條件: Memory > 85%
  行動:
    - 通知值班人員
    - 檢查記憶體洩漏
    - 考慮重啟服務
```

### 業務告警

```yaml
# Warning
- 名稱: Pipeline 持續失敗
  條件: 1小時內失敗 > 5次
  行動:
    - 通知相關團隊
    - 分析失敗原因
    - 暫停自動部署

- 名稱: 部署異常
  條件: 部署後錯誤率上升 > 50%
  行動:
    - 立即通知 Tech Lead
    - 建議回滾
    - 阻擋新部署
```

---

## 📊 報表生成

### 每日報表

```markdown
# 每日安全與系統報告
日期: 2025-12-18

## 安全摘要
- VPN 連線總數: 156次
- 成功登入: 154次
- 失敗登入: 2次
- 異常事件: 0起

## 系統狀態
- 服務可用性: 100%
- 平均回應時間: 125ms
- CI/CD Pipeline: 成功 45, 失敗 3

## 團隊活動
- 總 Commits: 47
- Merge Requests: 12
- Code Reviews: 8

## 需關注項目
- ⚠️ Staging 環境磁碟使用 > 80%
- ℹ️ 2位使用者從新IP登入（已確認）

報告生成時間: 2025-12-19 00:00:00
```

### 每週報告

```markdown
# 每週安全與效能報告
週次: 2025-W51 (12/11 - 12/18)

## 安全態勢
- 安全事件: 0起
- 異常行為偵測: 3起 (已確認為正常)
- 權限變更: 2次 (已審核)
- 漏洞掃描: 已完成，無高危漏洞

## 系統效能
- 平均可用性: 99.95%
- 服務中斷: 0次
- 平均延遲: VPN 45ms, 服務 130ms

## 團隊生產力
- 總 Commits: 287
- 部署次數: 23次
- 平均 PR 處理時間: 4.2小時

## 改進建議
1. 增加 Dev 環境資源
2. 優化資料庫查詢效能
3. 更新 3個過期套件

報告生成時間: 2025-12-19 09:00:00
```

### 每月報告

```markdown
# 每月技術與安全評估報告
月份: 2025-12

## 執行摘要
本月系統運行穩定，安全態勢良好，團隊生產力持續提升。

## 安全分析
- 成功阻擋外部攻擊: 15次
- 內部安全事件: 0起
- 合規性檢查: 通過
- 安全培訓參與率: 100%

## 系統可靠性
- 月度可用性: 99.97%
- 計劃性維護: 2次 (總計 30分鐘)
- 非計劃性中斷: 0次

## 容量規劃
- 當前使用率: 65%
- 預估6個月後: 82%
- 建議: 考慮於 Q2 擴充容量

## 成本分析
- 本月總成本: $450
- 與上月比較: +5%
- ROI: 良好

提交給: 管理層
報告生成時間: 2025-12-31 09:00:00
```

---

## 🔍 日誌查詢範例

### 查詢誰做了什麼

```elasticsearch
# 查詢特定使用者的所有操作
user:"engineer_a" AND timestamp:[now-7d TO now]

# 查詢特定服務的存取記錄
service:"gitlab" AND action:"git_push"

# 查詢失敗的操作
status:"failed" OR result:"error"

# 查詢大檔案傳輸
data_transfer_mb:>100

# 查詢異常時間的操作
hour:[0 TO 6] OR hour:[23 TO 23]
```

### 安全分析查詢

```elasticsearch
# 查詢可疑登入
(login_failed:true AND attempts:>3)
OR
(login_success:true AND (hour:<6 OR hour:>23))
OR
(login_success:true AND new_ip:true)

# 查詢權限變更
event_type:"permission_change" 
AND timestamp:[now-24h TO now]

# 查詢資料存取模式
action:"database_query"
AND (rows_affected:>1000 OR query_time:>5000)
```

---

## 📚 相關配置

實際配置檔案參考：
- `configs/monitoring/filebeat.yml` - 日誌收集配置
- `configs/monitoring/logstash-pipeline.conf` - 日誌處理
- `configs/monitoring/prometheus-rules.yml` - 告警規則
- `configs/monitoring/grafana-dashboards/` - 儀表板定義
