# 公司技術架構整體設計

## 📋 文檔資訊

- **建立日期**：2025-12-18
- **架構師**：Mike (CTO)
- **目標團隊規模**：中型團隊 (10-50人)
- **架構版本**：v1.0

---

## 🎯 核心設計理念

### 單一入口原則
> 所有外部訪問必須通過 VPN Gateway，實現完整的存取控制和稽核追蹤

```
Internet
    ↓
[VPN Gateway] ← 唯一對外開放的入口點
    ↓
內部服務網路
├── GitLab Server
├── Dev Environment
├── Staging Environment
├── Documentation Server
├── Monitoring System
└── Database Servers
    ↑
所有服務只對 VPN Gateway 開放
```

---

## 🏗️ 三層網路架構

### 第一層：公網邊界層

```
職責：接收外部連線
開放端口：僅 VPN (51820/UDP)
對外 IP：1 個公網 IP

組件：
└── VPN Gateway Server
    ├── 身份驗證
    ├── 流量加密
    └── 日誌記錄
```

### 第二層：內網服務層

```
職責：提供各種服務
開放範圍：僅對 VPN Gateway 開放
IP 規劃：私有 IP (10.0.x.x)

組件：
├── GitLab Server (10.0.1.10)
├── Dev Environment (10.0.2.x)
├── Staging Environment (10.0.3.x)
├── Documentation (10.0.4.10)
├── Monitoring (10.0.5.x)
└── Database (10.0.6.x)
```

### 第三層：監控稽核層

```
職責：記錄所有操作
收集來源：所有層級
數據流向：單向（只收集，不影響業務）

組件：
└── 監控系統
    ├── 日誌收集（ELK）
    ├── 指標監控（Prometheus）
    ├── 視覺化（Grafana）
    └── 告警系統（Alertmanager）
```

---

## 🔐 安全設計

### 網路隔離策略

```
規則 1: 外部 → 內部
❌ Internet → 任何內部服務（直接連線）
✅ Internet → VPN Gateway（唯一允許）

規則 2: VPN Gateway → 內部服務
✅ VPN Gateway → 所有內部服務（有權限的）
✅ 內部服務 → VPN Gateway（回傳流量）

規則 3: 服務間通訊
✅ 服務 A → 服務 B（內部網路）
❌ 外部 → 服務 A（跳過 VPN）

規則 4: 內部 → 外部
✅ 內部服務 → Internet（透過 NAT）
✅ 更新、下載套件等
```

### 防火牆規則

**VPN Gateway 防火牆**：
```bash
# 允許入站
- UDP 51820: VPN 連線
- TCP 22: SSH 管理（僅特定 IP）

# 允許出站
- 所有到內網的流量
- 允許回應流量

# 拒絕
- 其他所有入站流量
```

**內部服務防火牆**：
```bash
# 允許入站
- 僅來自 10.0.0.1 (VPN Gateway) 的流量
- 僅來自內網的流量

# 拒絕
- 所有來自外部的直接連線
```

---

## 📊 流量路徑設計

### 員工存取服務完整流程

```
步驟 1: 建立 VPN 連線
員工電腦 → WireGuard Client → VPN Gateway
    ↓
驗證身份 (金鑰配對)
    ↓
分配內網 IP (10.0.0.x)
    ↓
建立加密隧道

步驟 2: DNS 解析
員工訪問: gitlab.company.internal
    ↓
VPN 提供的 DNS 解析
    ↓
gitlab.company.internal → 10.0.1.10

步驟 3: 流量轉發
員工請求 → VPN Gateway (10.0.0.1)
    ↓
VPN Gateway 檢查權限
    ↓
轉發到 GitLab (10.0.1.10)
    ↓
GitLab 處理請求
    ↓
回應 → VPN Gateway → 員工

步驟 4: 全程記錄
每個步驟都記錄到監控系統
    ↓
誰 (員工 A)
何時 (2025-12-18 10:30:15)
做什麼 (存取 GitLab)
結果 (成功/失敗)
```

---

## 🎯 關鍵特性

### ✅ 完整可見性
- 所有流量經過 VPN Gateway
- 無法繞過監控
- 完整稽核軌跡

### ✅ 集中控制
- 單點權限管理
- 撤銷權限立即生效
- 統一安全策略

### ✅ 彈性擴展
- 新增服務無需改變架構
- 服務可部署在不同機器
- 支援水平擴展

### ✅ 災難恢復
- VPN Gateway 可快速遷移
- 內部服務獨立備份
- 監控數據獨立儲存

---

## 📈 擴展性設計

### 小規模（起步）
```
1 台 VPN Gateway
3-5 台內部服務器
投資: $300-400/月
```

### 中規模（成長期）
```
2 台 VPN Gateway (高可用)
10-15 台內部服務器
專用監控叢集
投資: $800-1200/月
```

### 大規模（成熟期）
```
VPN Gateway 叢集
Kubernetes 叢集
分散式監控
投資: $2000+/月
```

---

## ⚠️ 關鍵考量

### 單點故障風險
- **問題**: VPN Gateway 故障 = 全部服務無法存取
- **解決**: 
  - 備用 VPN Gateway (冷備份)
  - 定期備份配置
  - 監控 VPN Gateway 健康狀態
  - 快速恢復程序 (< 15 分鐘)

### 效能瓶頸
- **問題**: 所有流量經過 VPN Gateway
- **解決**:
  - 選擇高效能機器
  - 監控頻寬使用
  - 必要時啟用第二台 Gateway

### 複雜度管理
- **問題**: 架構較傳統方式複雜
- **解決**:
  - 完整文檔
  - 自動化腳本
  - 團隊培訓

---

## 📅 實施優先級

### P0 - 立即實施 (第1個月)
- [x] VPN Gateway 部署
- [x] 基本防火牆規則
- [x] GitLab 伺服器
- [x] 開發環境

### P1 - 短期目標 (第2個月)
- [ ] 測試環境
- [ ] 基本監控
- [ ] 備份機制
- [ ] 文檔完善

### P2 - 中期目標 (第3-6個月)
- [ ] 完整監控與告警
- [ ] OAuth2 SSO
- [ ] 自動化部署
- [ ] 災難恢復演練

### P3 - 長期優化 (6個月後)
- [ ] 高可用架構
- [ ] 效能優化
- [ ] 安全加固
- [ ] 合規認證

---

## 🔗 相關文檔

- [網路拓撲圖](./02-網路拓撲圖.md)
- [安全策略](./03-安全策略.md)
- [監控方案](./04-監控方案.md)
- [實施計畫](./05-實施計畫.md)
- [運維手冊](./06-運維手冊.md)
