# GitLab CI/CD é…ç½®æª”æ¡ˆ
# ç”¨æ–¼è‡ªå‹•å»ºç½®ã€æ¸¬è©¦ã€æ‰“åŒ…å’Œéƒ¨ç½² Spring Boot æ‡‰ç”¨ç¨‹å¼

stages:
  - test          # æ¸¬è©¦éšæ®µ
  - build         # å»ºç½®éšæ®µ
  - docker        # Docker æ‰“åŒ…éšæ®µ
  - deploy        # éƒ¨ç½²éšæ®µ

variables:
  # Docker æ˜ åƒæª”è¨­å®š
  DOCKER_IMAGE: "registry.gitlab.com/$CI_PROJECT_PATH"
  DOCKER_TAG: "$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
  # Java/Gradle è¨­å®š
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# å¿«å–è¨­å®šï¼ˆåŠ é€Ÿå»ºç½®ï¼‰
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .gradle/wrapper
    - .gradle/caches

# ==========================================
# éšæ®µ 1: å–®å…ƒæ¸¬è©¦
# ==========================================
test:
  stage: test
  image: gradle:8.14-jdk17
  script:
    - echo "ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
    - ./gradlew test --no-daemon
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/reports/tests/test/
  only:
    - branches
    - tags

# ==========================================
# éšæ®µ 2: å»ºç½® JAR
# ==========================================
build:
  stage: build
  image: gradle:8.14-jdk17
  script:
    - echo "ğŸ”¨ å»ºç½®æ‡‰ç”¨ç¨‹å¼..."
    - ./gradlew clean build -x test --no-daemon
    - echo "âœ… å»ºç½®å®Œæˆ"
    - ls -lh build/libs/
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 day
  only:
    - branches
    - tags

# ==========================================
# éšæ®µ 3: æ‰“åŒ… Docker æ˜ åƒæª”
# ==========================================
docker:
  stage: docker
  image: docker:latest
  services:
    - docker:dind
  dependencies:
    - build
  before_script:
    - echo "ğŸ” ç™»å…¥ GitLab Container Registry..."
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "ğŸ³ å»ºç½® Docker æ˜ åƒæª”..."
    - docker build -f Dockerfile.simple -t $DOCKER_IMAGE:$DOCKER_TAG .
    - docker tag $DOCKER_IMAGE:$DOCKER_TAG $DOCKER_IMAGE:latest
    - echo "ğŸ“¤ æ¨é€æ˜ åƒæª”åˆ° Registry..."
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
    - echo "âœ… Docker æ˜ åƒæª”å·²æ¨é€"
    - echo "æ˜ åƒæª”: $DOCKER_IMAGE:$DOCKER_TAG"
  only:
    - main
    - master
    - develop
    - tags

# ==========================================
# éšæ®µ 4: éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
# ==========================================
deploy:dev:
  stage: deploy
  image: alpine:latest
  dependencies: []
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEV_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ..."
    - |
      ssh $DEV_SERVER_USER@$DEV_SERVER_HOST << 'EOF'
        cd /opt/jdemo
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        docker-compose pull
        docker-compose up -d
        echo "âœ… éƒ¨ç½²å®Œæˆ"
      EOF
  environment:
    name: development
    url: http://$DEV_SERVER_HOST:8080
  only:
    - develop
  when: manual

# ==========================================
# éšæ®µ 5: éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ
# ==========================================
deploy:prod:
  stage: deploy
  image: alpine:latest
  dependencies: []
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $PROD_SERVER_HOST >> ~/.ssh/known_hosts
  script:
    - echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
    - |
      ssh $PROD_SERVER_USER@$PROD_SERVER_HOST << 'EOF'
        cd /opt/jdemo
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        docker-compose pull
        docker-compose up -d
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        
        # å¥åº·æª¢æŸ¥
        echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•..."
        sleep 10
        if curl -s http://localhost:8080/hello?name=healthcheck > /dev/null; then
          echo "âœ… å¥åº·æª¢æŸ¥é€šé"
        else
          echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—"
          exit 1
        fi
      EOF
  environment:
    name: production
    url: https://your-domain.com
  only:
    - main
    - master
    - tags
  when: manual
